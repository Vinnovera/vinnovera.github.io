<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Bildmanipulering i JavaScript - Vinnovera</title>

	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<meta name="description" content="När det läggs ett digitalt filter över en bild manipuleras pixeldatan i bilden. Färgerna i bilden räknas om för varje pixel och sedan visas en n...">

	<meta property="og:title" content="Bildmanipulering i JavaScript" />
	<meta property="og:url" content="http://vinnovera.se/blogg/2013/12/13/bildmanipulering-i-javascript" />
	<meta property="og:image" content="http://vinnovera.se/images/logoOgImage.png" />
	<meta property="og:description" content="När det läggs ett digitalt filter över en bild manipuleras pixeldatan i bilden. Färgerna i bilden räknas om för varje pixel och sedan visas en n..." />


	<!--[if lt IE 9]>
	<script>
	    var e = ['header', 'hgroup', 'nav', 'article', 'aside', 'section', 'footer'],
	        i = e.length;

	    for(i; i--;) {
	        document.createElement(e[i]);
	    }
	</script><![endif]-->

	<link href="/favicon.ico" rel="icon">
	<link href="http://vinnovera.se/rss.xml" rel="alternate" title="Vinnovera" type="application/rss+xml">

	<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,300,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/stylesheets/vinnovera.css">

	<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-2035593-3']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

</head>

<body >
<header id="header">
	
		<h1>
			<a href="/">Vinnovera</a>
		</h1>
	
	<a href="#" class="toggle-menu" id="toggle-menu">
		<span></span>
		<span></span>
		<span></span>
	</a>
	<nav id="navigation">
		<a href="/">Hem</a>
		<a href="/#projekt">Kunder &amp; projekt</a>
		<a href="/#blogg">Blogg</a>
		<a href="/#vi">Vi</a>
		<a href="/#kontakt">Kontakt</a>
		<!--a class="labs" href="http://labs.vinnovera.se">Labs</a-->
	</nav>
</header>

<a href="#" class="to-top" id="scrollUp">Till toppen</a>
	<nav class="post-navigation">
			<a class="basic-alignment next" href="/blogg/2013/12/12/unit-testing" title="Nästa inlägg: Unit Testing">Nästa</a>
			<a class="basic-alignment prev" href="/blogg/2013/12/14/vinnovera-pepparkakor" title="Föregående inlägg: Vinnovera-pepparkakor">Föregående</a>
	</nav>
	<section class="wrapper post">
		<article>
			<header>
				<h1>Bildmanipulering i JavaScript</h1>
					<p class="meta">
						<span>Alexandra Bjelkholm</span>
						| <time datetime="2013-12-13T17:17" pubdate><span class='year'>2013</span>-<span class='month'>12</span>-<span class='day'>13</span></time>
						|
						<span class="categories">
							<a href="/blogg/tagg/javascript/">Javascript</a>, <a href="/blogg/tagg/filter/">Filter</a>
						</span>
					</p>
			</header>
			<div>
				<p>När det läggs ett digitalt filter över en bild manipuleras pixeldatan i bilden. Färgerna i bilden räknas om för varje pixel och sedan visas en ny bild med de nya värderna. I fortsättningen kommer jag att använda termen filter för att beskriva manipuleringen<!--more--> av bildens data med hjälp av Javascript.</p>
<p>Några vanligt förekommande filter är inverterade färger, sepia, blur, kontrastökning, gråskala med mera.</p>
<p>I dagsläget är det vanligast att manipulera bilderna i t.ex. Photoshop innan de används på en hemsida, men det finns alternativ och ett av dom är Javascript.</p>
<h2 id="varf-r-ska-man-anv-nda-filter-">Varför ska man använda filter?</h2>
<p>De som underhåller webbplatser är oftast inte själva utvecklare eller grafiker. Vill de placera samma bild på flera olika ställen men med olika filter behöver de inte själva editera bilden med hjälp av externa verktyg.</p>
<p>Om en sida har flera olika instanser av samma bild med olika filter, t.ex. porträttbilder av Andy Warhol, behöver browsern endast hämta bilden en gång. Det kan leda till en snabbare site med färre anrop.</p>
<h2 id="kan-man-anv-nda-filter-">Kan man använda filter?</h2>
<p>Om browsern stödjer canvas-objektet kan man använda filter. Idag har följande browsers stöd för canvas:</p>
<ul>
<li>Internet Explorer 9+</li>
<li>Firefox</li>
<li>Opera</li>
<li>Chrome</li>
<li>Safari</li>
<li>Mobile browsers</li>
</ul>
<p>I Android 4.0 ursprungs browser finns det, vad som antas vara, en bugg som gör att anges alpha i något annat än 0 eller 255 ändras pixelns färg istället.</p>
<p>Prestandan för canvas skiljer sig åt på olika plattformar. Desktop har generellt bra prestanda men mobila browsers kan vara långsammare.</p>
<h2 id="hur-fungerar-filter-">Hur fungerar filter?</h2>
<p>Som nämnt tidigare handlar det om att räkna om värden i bildens pixeldata. För att kunna manipulera bilder behövs ett canvas att rita på och ett ImageData-objekt.</p>
<p>Ett ImageData-objekt är en del av ett canvas, inte en bild eller en form. Objektet innehåller information för varje pixel inom den delen. Informationen består av fyra delar per pixel, RGBA:</p>
<p>R - Röd     (0-255) <br />
G - Grön     (0-255) <br />
B - Blå        (0-255) <br />
A - Alpha     (0-255, 0 = helt osynlig - 255 = helt synlig)</p>
<p>Är en pixel röd och synlig har den värdet (255,0,0,255) och det är de värden som lagras i data-egenskapen hos ImageData-objektet. Principen för att rita på ett canvas är samma för bilder som för andra objekt, därför beskrivs först hur man ritar en simpel form.</p>
<h3 id="form">Form</h3>
<p>Koden nedan skapar ett objekt som är 100 x 100 px, där varje pixel är blå, och placerar objektet på ett canvas 10px från kanterna.</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> c = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"myCanvas"</span>);
<span class="hljs-keyword">var</span> ctx = c.getContext(<span class="hljs-string">"2d"</span>);

<span class="hljs-comment">//Skapa ett objekt att arbeta med</span>
<span class="hljs-keyword">var</span> imageData = ctx.createImageData(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);

<span class="hljs-comment">//Loopa igenom pixlarna</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;imageData.data.length; i+=<span class="hljs-number">4</span>) {
    imageData.data[i+<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;      <span class="hljs-comment">//red</span>
    imageData.data[i+<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;      <span class="hljs-comment">//green</span>
    imageData.data[i+<span class="hljs-number">2</span>] = <span class="hljs-number">255</span>;    <span class="hljs-comment">//blue</span>
    imageData.data[i+<span class="hljs-number">3</span>] = <span class="hljs-number">255</span>;    <span class="hljs-comment">//alpha</span>
}

<span class="hljs-comment">//Skriv ut objektet på canvaset</span>
ctx.putImageData(imageData,<span class="hljs-number">10</span>,<span class="hljs-number">10</span>);</code></pre><p>Resultat:<br /><img src="https://lh3.googleusercontent.com/eMaoG_Om5swKW1iyfLoZ36M_zw7LRuYk0A6oxVqzYV7JKblIScg7ILDyGDiVkGCNh3S-BOKydcM18rtiZBt4-9Xvvi5BiCMMpupJPnzMiNmvc2qFkxBVHYJJlA" alt=""></p>
<h4 id="funktioner">Funktioner</h4>
<h5 id="createimagedata-">createImageData():</h5>
<p>Skapar ett nytt tomt ImageData-objekt. Objektets pixelvärden är ursprungligen (0,0,0,0), svarta och genomskinliga. Metoden används om det inte redan innan finns ett objekt att arbeta med, t.ex en bild, eller om ett objekt ska kopieras.</p>
<p>Syntax:</p>
<p>Det finns två versioner av metoden,</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> imgData = ctx.createImageData(width,height);</code></pre><p><ul></p>
<p><li>width = Bredden på det nya ImageData-objektet i px.</li></p>
<p><li>height = Höjden på det nya ImageData-objektet i px.</li>
</ul></p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> imgData = ctx.createImageData(imageData)</code></pre><p><ul></p>
<p><li>imageData = ett annat ImageData-objekt.</li>
</ul></p>
<h5 id="putimagedata-">putImageData():</h5>
<p>Skriver ut pixeldatan från ett specificerat ImageData-objekt på canvaset.</p>
<p>Syntax:</p>
<pre><code class="hljs javascript">ctx.putImageData(imgData, x, y, dirtyX, dirtyY, dirtyWidth, dirtyHeight)</code></pre><ul>
<li>imgData = Det imageData-objekt som ska skrivas ut på canvaset.</li>
<li>x = x-koordinaten för det övre vänstra hörnet av ImageData-objektet, angivet i px.</li>
<li>y = y-koordinaten för det övre vänstra hörnet av ImageData-objektet, angivet i px.</li>
<li>dirtyX = (optional) Det horizontella x-värdet att placera bilden på, angivet i px.</li>
<li>dirtyY = (optional) Det horizontella y-värdet att placera bilden på, angivet i px.</li>
<li>dirtyWidth = (optional) Bredden som ska användas för att rita ut bilden på canvaset.</li>
<li>dirtyHeight =(optional) Höjden som ska användas för att rita ut bilden på canvaset.</li>
</ul>
<h3 id="bild">Bild</h3>
<p>För att manipulera en bild behövs två ytterligare funktioner, drawImage och getImageData. Funktionen createImageData används när man vill kopiera en existerande bild eller för att skapa en tom yta.</p>
<p>Html:</p>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"image"</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"src.jpg"</span> <span class="hljs-attribute">alt</span>=<span class="hljs-value">""</span> <span class="hljs-attribute">width</span>=<span class="hljs-value">"220"</span> <span class="hljs-attribute">height</span>=<span class="hljs-value">"277"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">canvas</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"myCanvas"</span> <span class="hljs-attribute">width</span>=<span class="hljs-value">"220"</span> <span class="hljs-attribute">height</span>=<span class="hljs-value">"277"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">canvas</span>&gt;</span></code></pre><p>Script:</p>
<pre><code class="hljs javascript"><span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"image"</span>).onload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> c = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"myCanvas"</span>);
    <span class="hljs-keyword">var</span> ctx = c.getContext(<span class="hljs-string">"2d"</span>);

    <span class="hljs-comment">//Hämta bild</span>
    <span class="hljs-keyword">var</span> img = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"image"</span>);

        <span class="hljs-comment">//Rita ut bild på canvas</span>
    ctx.drawImage(img,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);

    <span class="hljs-comment">//Hämta bilddata</span>
    <span class="hljs-keyword">var</span> imgData = ctx.getImageData(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,c.width,c.height);

    <span class="hljs-comment">// invertera färgerna i bilden</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;imgData.data.length; i+=<span class="hljs-number">4</span>) {
        imgData.data[i]=<span class="hljs-number">255</span>-imgData.data[i];
        imgData.data[i+<span class="hljs-number">1</span>]=<span class="hljs-number">255</span>-imgData.data[i+<span class="hljs-number">1</span>];
        imgData.data[i+<span class="hljs-number">2</span>]=<span class="hljs-number">255</span>-imgData.data[i+<span class="hljs-number">2</span>];
        imgData.data[i+<span class="hljs-number">3</span>]=<span class="hljs-number">255</span>;
    }

    <span class="hljs-comment">//Skriv ut den manipulerade bilden på canvaset</span>
    ctx.putImageData(imgData,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
}</code></pre><p>Resultat:<br /><img src="https://lh6.googleusercontent.com/BZDl6xazl4AZS4_vbJJK2ZzWN_MVIR8KWM3F7dwCTHGiI0Ryk-Ejqr8_GlsFN0JZH8w_dj61KYmrRL4Ad5_niAfjblRPSGIiA4gVDstauj-G7bkLTt2Q2O31Pg" alt=""></p>
<h4 id="funktioner">Funktioner</h4>
<h5 id="drawimage-">drawImage():</h5>
<p>Ritar ut en bild, video eller ett canvas på ett canvas. Metoden kan även rita ut delar av en bild och ändra en bilds eller videos storlek.</p>
<p>Syntax:</p>
<pre><code class="hljs javascript">context.drawImage(img,x,y);
context.drawImage(img,x,y,width,height);
ctx.drawImage(img,sx,sy,swidth,sheight,x,y,width,height);</code></pre><ul>
<li>img = Det element som ska användas - bild, canvas eller video.</li>
<li>x = x-koordinaten där elementet ska placeras.</li>
<li>y = y-koordinaten där elementet ska placeras.</li>
<li>width = (optional)  vidden av elementet som ska användas (öka el. minska strl på elem).</li>
<li>height = (optional) höjden av elementet som ska användas (öka el. minska strl på elem).</li>
<li>sx = (optional) x-koordinaten där bilden ska börja skäras.</li>
<li>sy = (optional) y-koordinaten där bilden ska börja skäras.</li>
<li>swidth = (optional) vidden av den beskurna bilden.</li>
<li>sheight = (optional) höjden av den beskurna bilden.</li>
</ul>
<h5 id="getimagedata-">getImageData():</h5>
<p>Retunerar ett ImageData-objekt som kopierat pixeldatan från en specificerad del av canvaset.</p>
<p>Syntax:</p>
<pre><code class="hljs javascript">ctx.getImageData(x, y, width, height)</code></pre><ul>
<li>x = x-koordinaten för det övre vänstra hörnet som den ska börja kopiera från, angivet i px.</li>
<li>y = y-koordinaten för det övre vänstra hörnet som den ska börja kopiera från, angivet i px.</li>
<li>width = Bredden på det du vill kopiera.</li>
<li>height =Höjden på det du vill kopiera.</li>
</ul>
<h2 id="slutsatser">Slutsatser</h2>
<p>När jag jämförde två sidor, en där jag hade två bilder och en där jag hade en bild som jag skrev ut två gånger med hjälp av filter-funktioner, fick jag följande resultat:</p>
<table class="airy">
<tr>
<td></td>
<td>Javascript</td>
<td>två bilder</td>
</tr>
<tr>
<td>Antal requests</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>kb överfört</td>
<td>149</td>
<td>285</td>
</tr>
<tr>
<td>paint (ms)</td>
<td>3.0</td>
<td>39.2</td>
</tr>
<tr>
<td>hämta bild/bilder (ms)</td>
<td>23</td>
<td>150</td>
</tr>
<tr>
<td>finished loading (ms)</td>
<td>117</td>
<td>198</td>
</tr>
</table>


<p>Jag fick inte de resultat jag hade väntat mig och det beror främst på att jag trodde att paint-tiden skulle vara högre när jag använde canvas-objektet. Tittar man på ‘kb överfört’ tycker jag att man tydligt ser att fördelen men att använda filter är att man bara behöver ladda ner en bild. Tänker man den situationen i större skala med t.ex tio stycken bilder blir filter betydligt snabbare. Javascriptet jag använde var minimalt och använder man ett komplexare skript skulle tiden öka för att exekvera skriptet.</p>
<p>Ett ytterligare alternativ som är värt att nämna är web-kit filter. Varför jag inte anser att det är användbart än är att två av de störta webbläsarna, Firefox och Internet Explorer, inte har stöd för det. Skulle de utveckla stöd kan det bli ett starkt alternativ.</p>
<h3 id="bibliotek">Bibliotek</h3>
<p>Jag tror inte att det kommer att vara tidseffektivt att skriva ett eget Javascript-plugin. Uträkningarna är komplexa och det krävs väldigt noga testning för att inte slöa ner webbsidor. Nedan är några av de bibliotek som jag hittat som verkar ha potential.</p>
<p>Det bibliotek som verkar användas mest för tillfället är fabricjs. Det kan bero på att det innehåller väldigt mycket mer än bara filter - t.ex. former, drag-n-drop, resize med flera. Jag har även tittat på följande:</p>
<ul>
<li>Filterr2 <a href="https://github.com/alexmic/filtrr/tree/master/filtrr2">https://github.com/alexmic/filtrr/tree/master/filtrr2</a><br />
Open source som inte känns helt färdigutvecklat. Senaste buggfixen var fem månader sedan.</li>
<li>Pixastic <a href="http://www.pixastic.com/lib/docs/">http://www.pixastic.com/lib/docs</a><br />
Ett gratis bibliotek där du själv kan välja vilka komponenter du vill ladda ner.</li>
<li>glfx.js <a href="https://github.com/evanw/glfx.js">https://github.com/evanw/glfx.js</a><br />
Ett bibliotek som använder WebGL. Stödjs endast av de senaste browsers.</li>
<li>camanjs <a href="http://camanjs.com/">http://camanjs.com/</a><br />
Jag tror att camanjs har störts potential att vara användbart. Biblioteket har noga utförd dokumentation, uppdateras kontinuerligt, uppmanar till tester och är helt gratis.</li>
</ul>
<h2 id="referenser">Referenser</h2>
<ul>
<li><a href="http://www.khronos.org/registry/typedarray/specs/latest/#7.1">http://www.khronos.org/registry/typedarray/specs/latest/#7.1</a></li>
<li><a href="http://www.w3schools.com/tags/ref_canvas.asp">http://www.w3schools.com/tags/ref_canvas.asp</a></li>
<li><a href="http://html5doctor.com/video-canvas-magic/">http://html5doctor.com/video-canvas-magic/</a></li>
<li><a href="http://caniuse.com/css-filters">http://caniuse.com/css-filters</a></li>
</ul>
<p>Codepen :
(Egna bilder behövs för att testa skripten) <br />
Länk till Javascript version: <a href="http://codepen.io/Sandra/pen/LjGgh">http://codepen.io/Sandra/pen/LjGgh</a> <br />
Länk till version med två bilder :  <a href="http://codepen.io/Sandra/pen/lrjvJ">http://codepen.io/Sandra/pen/lrjvJ</a></p>

			</div>
		</article>
			<article class="authorDescription">
				<div>
						<img src="/images/profiles/sandra.jpg" alt="Alexandra Bjelkholm" />
				</div>
				<div>
					<h3>Alexandra Bjelkholm</h3>
					<a href="mailto: alexandra@vinnovera.se">(alexandra@vinnovera.se)</a>
					<p>Alexandra Bjelkholm jobbar med frontend på Vinnovera.</p>
					<p>Vi är specialister på frontend-utveckling och ser gränssnitt för desktop, surfplattor och mobiltelefoner som vårt hantverk. Vi vill jobba med kunder som tycker att kvalitet är viktigt, tänker långsiktigt och vill skapa webbupplevelser med det där lilla extra.</p>
					<p><a href="/blogg">Tillbaka till bloggen</a> | <a href="/blogg/2013/11/18/om-vinnovera/">Mer om Vinnovera</a></p>
				</div>
			</article>

			<div>
				<div class="wrapper comments">
					<h2>Kommentera</h2>
					<div id="disqus_thread" aria-live="polite"><script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vinnovera'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
				</div>
			</div>
	</section>

<footer role="contentinfo">
	<span class="adr">
		<span class="street-address">Västerlånggatan 27</span>
		<span class="postal-code">111 29</span>
		<span class="locality">Stockholm</span>
		<a class="map-link" href="https://www.google.com/maps/place/Vinnovera+AB/@59.3252213,18.0692205,17z/data=!3m1!4b1!4m2!3m1!1s0x465f77e26eb236e1:0x314b77ee3a5d5ea1">(Karta)</a>
	</span>

	<span class="tel">08 - 5000 10 90</span>
	<a href="mailto:info@vinnovera.se" class="email">info@vinnovera.se</a>
</footer>
<script src="/javascripts/components/mootools.js"></script>
<script src="/javascripts/components/mootools-more.js"></script>
<script src="/javascripts/components/jsoverlay.js"></script>
<script src="/javascripts/vinnovera.js"></script>
</body>
</html>